// Utilites for working with redis within the echo framework

package redis

import (
	"fmt"
	"reflect"

	redis "gopkg.in/redis.v4"

	"github.com/labstack/echo"
)

// Returns a redis client from a given echo context
func FromContext(ctx echo.Context) (Client, error) {
	v := ctx.Get("redis.client")
	client, ok := v.(Client)
	if !ok {
		return nil, fmt.Errorf("%v is not a Client", reflect.TypeOf(v))
	}

	return client, nil
}

// Opens a redis connection to the configured redis server
// and places the connection on the request context
func Middleware(config *redis.Options) echo.MiddlewareFunc {
	return func(next echo.HandlerFunc) echo.HandlerFunc {
		return func(ctx echo.Context) error {
			// Create a new redis client
			client := NewClient(config)
			defer client.Close()

			// Add the client to the session, and serve the next handler
			ctx.Set("redis.client", client)

			return next(ctx)
		}
	}
}
